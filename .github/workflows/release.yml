name: Auto Release
run-name: Auto Release by ${{ github.actor }} ðŸš€
on:
  push:
    branches: [ main ]
    paths: [ metadata.env ]

env:
  BASE_URL: https://github.com

jobs:
  release:
    name: Release new version
    runs-on: ubuntu-latest
    outputs:
      RELEASE_ID: ${{ steps.create_release.outputs.RELEASE_ID }}

    steps:

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.TOKEN }}
        fetch-depth: 0 # Needed for tagging

    - name: Load metadata from metadata.env file
      id: metadata
      run: |
        set -a
        source metadata.env
        set +a
        echo "NAME=$NAME" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Install jq
      id: install_jq
      run: |
        if ! command -v jq &> /dev/null; then
          apt-get update && apt-get install -y jq
        fi

    - name: Detect release type
      id: version
      run: |
        # Check if it's a pre-release (contains RC, alpha, beta, dev, etc.)
        if [[ "${{ steps.metadata.outputs.VERSION }}" =~ -RC[0-9]*$ ]] || \
           [[ "${{ steps.metadata.outputs.VERSION }}" =~ -alpha[0-9]*$ ]] || \
           [[ "${{ steps.metadata.outputs.VERSION }}" =~ -beta[0-9]*$ ]] || \
           [[ "${{ steps.metadata.outputs.VERSION }}" =~ -dev[0-9]*$ ]] || \
           [[ "${{ steps.metadata.outputs.VERSION }}" =~ -pre[0-9]*$ ]]; then
          echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          echo "Detected PRE-RELEASE: ${{ steps.metadata.outputs.VERSION }}"
        else
          echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          echo "Detected STABLE RELEASE: ${{ steps.metadata.outputs.VERSION }}"
        fi

    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "${{ steps.metadata.outputs.VERSION }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag ${{ steps.metadata.outputs.VERSION  }} already exists!"
          exit 1
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git tag "${{ steps.metadata.outputs.VERSION  }}"
        git push origin main
        git push origin "${{ steps.metadata.outputs.VERSION  }}"

    - name: Create release
      id: create_release
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        if [[ "${{ steps.version.outputs.PRERELEASE }}" == "true" ]]; then
          RELEASE_NAME="ðŸš§ Pre-release ${{ steps.metadata.outputs.VERSION }}"
          RELEASE_BODY="Pre-release ${{ steps.metadata.outputs.VERSION }} - This is a pre-release version. \
          It may contain bugs and is not recommended for production use. Use with caution!\n\n\n \
          <img width='800' alt='Top 3D' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Top-3D.png' /> \
          <img width='800' alt='Bottom 3D' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Bottom-3D.png' /> \
          <img width='400' alt='Top' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Top.png' /> \
          <img width='400' alt='Bottom' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Bottom.png' />"
        else
          RELEASE_NAME="ðŸš€ Release ${{ steps.metadata.outputs.VERSION }}"
          RELEASE_BODY="Release ${{ steps.metadata.outputs.VERSION }}\n\n\n \
          <img width='800' alt='Top 3D' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Top-3D.png' /> \
          <img width='800' alt='Bottom 3D' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Bottom-3D.png' /> \
          <img width='400' alt='Top' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Top.png' /> \
          <img width='400' alt='Bottom' src='$BASE_URL/${{ github.repository }}/releases/download/${{ steps.metadata.outputs.VERSION }}/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Bottom.png' />"
        fi

        # Simple JSON without complex escaping
        RESPONSE=$(curl -X POST \
          -H "Authorization: token ${{ secrets.TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"tag_name\":\"${{ steps.metadata.outputs.VERSION }}\",\"name\":\"$RELEASE_NAME\",\"body\":\"$RELEASE_BODY\",\"draft\":false,\"prerelease\":${{ steps.version.outputs.PRERELEASE }}}" \
          "${{ github.api_url }}/repos/${{ github.repository }}/releases")

        # Extract release ID and upload URL
        RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
        echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT

        echo "Release created with ID: $RELEASE_ID"

    - name: Release summary
      id: release_summary
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        if [[ "${{ steps.version.outputs.PRERELEASE }}" == "true" ]]; then
          echo "âœ… Pre-release ${{ steps.metadata.outputs.VERSION  }} created successfully!"
        else
          echo "ðŸŽ‰ Stable release ${{ steps.metadata.outputs.VERSION  }} created successfully!"
        fi

  production-file-export:
    name: Export Production files
    needs: release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Load metadata from metadata.env file
      id: metadata
      run: |
        set -a
        source metadata.env
        set +a
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "YEAR=$(date +%Y)" >> $GITHUB_OUTPUT
        echo "NAME=$NAME" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "KIBOT_CONFIG=$KIBOT_CONFIG" >> $GITHUB_OUTPUT
        echo "PCB_FILE=$PCB_FILE" >> $GITHUB_OUTPUT
        echo "SCH_FILE=$SCH_FILE" >> $GITHUB_OUTPUT

    - name: Run KiBot for Production files
      uses: INTI-CMNB/KiBot@v2_k9
      with:
        config: ${{ steps.metadata.outputs.KIBOT_CONFIG }}
        dir: ./output
        schema: ${{ steps.metadata.outputs.SCH_FILE}}
        board: ${{ steps.metadata.outputs.PCB_FILE}}
        additional_args: -E NAME=${{ steps.metadata.outputs.NAME }}

    - name: Prepare artifacts
      id: artifacts
      run: |
        tree
        mkdir artifacts
        cp output/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}.step ./artifacts
        cp output/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}*.png ./artifacts
        cp output/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}*.pdf ./artifacts/
        cp output/JLCPCB/*.zip ./artifacts/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-Gerber.zip
        cp output/JLCPCB/*bom* ./artifacts/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-BOM.csv
        cp output/JLCPCB/*cpl* ./artifacts/${{ steps.metadata.outputs.NAME }}-${{ steps.metadata.outputs.VERSION }}-CPL.csv
        tree artifacts

    - name: Upload Release artifacts
      env:
        KIBOT_CONFIG: ${{ steps.metadata.outputs.KIBOT_CONFIG }}
      run: |
        cd artifacts
        for file in *; do
          if [ -f "$file" ]; then
            echo "Uploading: $file"
            curl -L \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/octet-stream" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ needs.release.outputs.RELEASE_ID }}/assets?name=$file" \
              --data-binary "@$file"
          fi
        done
